{
	# Global options
	email {$ACME_EMAIL}
	# Optional: avoid leaking server version
	servers {
		header {
			-Server
		}
	}
}

{$DOMAIN} {
	encode zstd gzip

	# Basic security headers (tune CSP based on your needs)
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
		X-Frame-Options "DENY"
	}

	# Stripe backend under same-origin prefix.
	# Frontend should use: https://<domain>/stripe
	handle_path /stripe/* {
		reverse_proxy stripe-backend:4242 {
			header_up x-api-key {$STRIPE_API_KEY}
		}
	}

	# Core app API (Postgres-backed) under same-origin prefix.
	# Frontend should use: https://<domain>/api  (or simply /api)
	handle /api/* {
		reverse_proxy api:4000
	}

	# NOTE: Print server is intentionally NOT exposed by default.
	# If you want remote printing, consider running the print server on a private network/VPN.
	# Only expose it publicly if you fully understand the security implications.

	# Optional: basic health endpoint
	handle /health {
		respond "ok" 200
	}

	# Default: serve the frontend
	handle {
		reverse_proxy web:80
	}
}
