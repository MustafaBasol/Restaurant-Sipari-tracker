services:
  web:
    build:
      context: ..
      dockerfile: deploy/web.Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL-}
        VITE_STRIPE_BACKEND_URL: ${VITE_STRIPE_BACKEND_URL}
        VITE_PRINT_SERVER_URL: ${VITE_PRINT_SERVER_URL-}
        VITE_TURNSTILE_SITE_KEY: ${VITE_TURNSTILE_SITE_KEY-}
        VITE_SERVICE_ORIGIN_ALLOWLIST: ${VITE_SERVICE_ORIGIN_ALLOWLIST-}
        VITE_ALLOW_INSECURE_SERVICES: ${VITE_ALLOW_INSECURE_SERVICES-}
    restart: unless-stopped
    networks:
      - internal
      - traefik-net
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-net

      # Frontend
      - traefik.http.routers.kitchorify-web.rule=Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)
      - traefik.http.routers.kitchorify-web.entrypoints=websecure
      - traefik.http.routers.kitchorify-web.tls=true
      - traefik.http.routers.kitchorify-web.tls.certresolver=mytlschallenge
      - traefik.http.routers.kitchorify-web.priority=1000
      - traefik.http.services.kitchorify-web.loadbalancer.server.port=80
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  stripe-backend:
    build:
      context: ..
      dockerfile: deploy/services.Dockerfile
    command: ['node', 'server.cjs']
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4242
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PRICE_ID_MONTHLY: ${STRIPE_PRICE_ID_MONTHLY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET-}
      INTERNAL_API_BASE_URL: http://api:4000/api
      # Allow only your app origin (no hash/path)
      CORS_ORIGINS: ${CORS_ORIGINS}
      # Optional: if set, upstream expects x-api-key
      API_KEY: ${STRIPE_API_KEY-}
    expose:
      - '4242'
    networks:
      - internal
      - traefik-net
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-net

      # Stripe backend under same-origin prefix: /stripe/* (strip prefix before proxy)
      - traefik.http.middlewares.kitchorify-stripe-strip.stripprefix.prefixes=/stripe
      - traefik.http.routers.kitchorify-stripe.rule=(Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)) && PathPrefix(`/stripe`)
      - traefik.http.routers.kitchorify-stripe.entrypoints=websecure
      - traefik.http.routers.kitchorify-stripe.tls=true
      - traefik.http.routers.kitchorify-stripe.tls.certresolver=mytlschallenge
      - traefik.http.routers.kitchorify-stripe.priority=2000
      - traefik.http.routers.kitchorify-stripe.middlewares=kitchorify-stripe-strip
      - traefik.http.services.kitchorify-stripe.loadbalancer.server.port=4242
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  api:
    build:
      context: ..
      dockerfile: deploy/api.Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: ${DATABASE_URL}
      # Origin allowlist for non-same-origin access (same-origin proxy requests usually have no Origin)
      CORS_ORIGINS: ${CORS_ORIGINS}
      SESSION_TTL_DAYS: ${SESSION_TTL_DAYS-30}

      # Public URL used for email links (no trailing slash recommended)
      APP_PUBLIC_URL: ${APP_PUBLIC_URL-}

      # Email verification / reset
      EMAIL_VERIFICATION_TTL_MINUTES: ${EMAIL_VERIFICATION_TTL_MINUTES-60}
      PASSWORD_RESET_TTL_MINUTES: ${PASSWORD_RESET_TTL_MINUTES-30}

      # MailerSend
      MAILERSEND_ENABLED: ${MAILERSEND_ENABLED-}
      MAILERSEND_API_KEY: ${MAILERSEND_API_KEY-}
      MAILERSEND_FROM_EMAIL: ${MAILERSEND_FROM_EMAIL-}
      MAILERSEND_FROM_NAME: ${MAILERSEND_FROM_NAME-}
      MAILERSEND_SENDER_EMAIL: ${MAILERSEND_SENDER_EMAIL-}
      MAILERSEND_SENDER_NAME: ${MAILERSEND_SENDER_NAME-}

      # Cloudflare Turnstile
      TURNSTILE_ENABLED: ${TURNSTILE_ENABLED-false}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY-}

      # MFA (TOTP)
      MFA_ISSUER: ${MFA_ISSUER-Kitchorify}

      # Internal auth for stripe-backend -> api updates
      STRIPE_API_KEY: ${STRIPE_API_KEY-}
    expose:
      - '4000'
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:4000/health/db || exit 1']
      interval: 30s
      timeout: 5s
      retries: 5
    depends_on:
      - postgres
    networks:
      - internal
      - traefik-net
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-net

      # Core API under same-origin prefix: /api/*
      - traefik.http.routers.kitchorify-api.rule=(Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)) && PathPrefix(`/api`)
      - traefik.http.routers.kitchorify-api.entrypoints=websecure
      - traefik.http.routers.kitchorify-api.tls=true
      - traefik.http.routers.kitchorify-api.tls.certresolver=mytlschallenge
      - traefik.http.routers.kitchorify-api.priority=2100
      - traefik.http.services.kitchorify-api.loadbalancer.server.port=4000

      # Optional root health check: /health -> api:/health
      - traefik.http.routers.kitchorify-health.rule=(Host(`${DOMAIN}`) || Host(`www.${DOMAIN}`)) && Path(`/health`)
      - traefik.http.routers.kitchorify-health.entrypoints=websecure
      - traefik.http.routers.kitchorify-health.tls=true
      - traefik.http.routers.kitchorify-health.tls.certresolver=mytlschallenge
      - traefik.http.routers.kitchorify-health.priority=2200
      - traefik.http.routers.kitchorify-health.service=kitchorify-api
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB-kitchorify}
      POSTGRES_USER: ${POSTGRES_USER-kitchorify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    expose:
      - '5432'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U "${POSTGRES_USER-kitchorify}" -d "${POSTGRES_DB-kitchorify}" -h 127.0.0.1 || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - internal
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  # Local daily backups (gzip) with retention.
  # NOTE: This protects you from accidental deletes/bugs, but NOT from VPS disk loss.
  # For true DR: sync deploy/backups off-host (S3/rsync) and test restores.
  pg-backup:
    image: prodrigestivill/postgres-backup-local:16
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB-kitchorify}
      POSTGRES_USER: ${POSTGRES_USER-kitchorify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: ${PG_BACKUP_SCHEDULE-@daily}
      BACKUP_KEEP_DAYS: ${PG_BACKUP_KEEP_DAYS-14}
      BACKUP_KEEP_WEEKS: ${PG_BACKUP_KEEP_WEEKS-8}
      BACKUP_KEEP_MONTHS: ${PG_BACKUP_KEEP_MONTHS-6}
      HEALTHCHECK_PORT: 8080
    volumes:
      - ./backups:/backups
    networks:
      - internal
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  print-server:
    profiles: ['print']
    build:
      context: ..
      dockerfile: deploy/services.Dockerfile
    command: ['node', 'printer-server.cjs']
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4243
      CORS_ORIGINS: ${CORS_ORIGINS}
      # Optional: if set, upstream expects x-api-key
      API_KEY: ${PRINT_API_KEY-}
      PRINT_TRANSPORT: ${PRINT_TRANSPORT-stdout}
      PRINTER_HOST: ${PRINTER_HOST-}
      PRINTER_PORT: ${PRINTER_PORT-9100}
      PRINTER_NAME: ${PRINTER_NAME-}
    expose:
      - '4243'
    networks:
      - internal
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

volumes:
  pgdata:

networks:
  internal:
    driver: bridge
  traefik-net:
    external: true
    name: traefik-net
