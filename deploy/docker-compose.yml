services:
  caddy:
    image: caddy:2.8
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    environment:
      DOMAIN: ${DOMAIN}
      ACME_EMAIL: ${ACME_EMAIL}
      # Optional: inject API keys to upstreams without exposing to browsers
      STRIPE_API_KEY: ${STRIPE_API_KEY-}
      PRINT_API_KEY: ${PRINT_API_KEY-}
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - web
      - stripe-backend
      - api
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  web:
    build:
      context: ..
      dockerfile: deploy/web.Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL-}
        VITE_STRIPE_BACKEND_URL: ${VITE_STRIPE_BACKEND_URL}
        VITE_PRINT_SERVER_URL: ${VITE_PRINT_SERVER_URL-}
        VITE_TURNSTILE_SITE_KEY: ${VITE_TURNSTILE_SITE_KEY-}
        VITE_SERVICE_ORIGIN_ALLOWLIST: ${VITE_SERVICE_ORIGIN_ALLOWLIST-}
        VITE_ALLOW_INSECURE_SERVICES: ${VITE_ALLOW_INSECURE_SERVICES-}
    restart: unless-stopped
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  stripe-backend:
    build:
      context: ..
      dockerfile: deploy/services.Dockerfile
    command: ['node', 'server.cjs']
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4242
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PRICE_ID_MONTHLY: ${STRIPE_PRICE_ID_MONTHLY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET-}
      INTERNAL_API_BASE_URL: http://api:4000/api
      # Allow only your app origin (no hash/path)
      CORS_ORIGINS: ${CORS_ORIGINS}
      # Optional: if set, upstream expects x-api-key
      API_KEY: ${STRIPE_API_KEY-}
    expose:
      - '4242'
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  api:
    build:
      context: ..
      dockerfile: deploy/api.Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: ${DATABASE_URL}
      # Origin allowlist for non-same-origin access (same-origin proxy requests usually have no Origin)
      CORS_ORIGINS: ${CORS_ORIGINS}
      SESSION_TTL_DAYS: ${SESSION_TTL_DAYS-30}

      # Public URL used for email links (no trailing slash recommended)
      APP_PUBLIC_URL: ${APP_PUBLIC_URL-}

      # Email verification / reset
      EMAIL_VERIFICATION_TTL_MINUTES: ${EMAIL_VERIFICATION_TTL_MINUTES-60}
      PASSWORD_RESET_TTL_MINUTES: ${PASSWORD_RESET_TTL_MINUTES-30}

      # MailerSend
      MAILERSEND_ENABLED: ${MAILERSEND_ENABLED-}
      MAILERSEND_API_KEY: ${MAILERSEND_API_KEY-}
      MAILERSEND_FROM_EMAIL: ${MAILERSEND_FROM_EMAIL-}
      MAILERSEND_FROM_NAME: ${MAILERSEND_FROM_NAME-}
      MAILERSEND_SENDER_EMAIL: ${MAILERSEND_SENDER_EMAIL-}
      MAILERSEND_SENDER_NAME: ${MAILERSEND_SENDER_NAME-}

      # Cloudflare Turnstile
      TURNSTILE_ENABLED: ${TURNSTILE_ENABLED-false}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY-}

      # MFA (TOTP)
      MFA_ISSUER: ${MFA_ISSUER-Kitchorify}

      # Super admin bootstrap (optional but recommended for production access)
      SUPER_ADMIN_EMAIL: ${SUPER_ADMIN_EMAIL-}
      SUPER_ADMIN_PASSWORD: ${SUPER_ADMIN_PASSWORD-}
      SUPER_ADMIN_FULL_NAME: ${SUPER_ADMIN_FULL_NAME-}

      # Internal auth for stripe-backend -> api updates
      STRIPE_API_KEY: ${STRIPE_API_KEY-}
    expose:
      - '4000'
    healthcheck:
      test: ['CMD-SHELL', 'curl -fsS http://localhost:4000/health/db || exit 1']
      interval: 30s
      timeout: 5s
      retries: 5
    depends_on:
      - postgres
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB-kitchorify}
      POSTGRES_USER: ${POSTGRES_USER-kitchorify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    expose:
      - '5432'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U "${POSTGRES_USER-kitchorify}" -d "${POSTGRES_DB-kitchorify}" -h 127.0.0.1 || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  # Local daily backups (gzip) with retention.
  # NOTE: This protects you from accidental deletes/bugs, but NOT from VPS disk loss.
  # For true DR: sync deploy/backups off-host (S3/rsync) and test restores.
  pg-backup:
    image: prodrigestivill/postgres-backup-local:16
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB-kitchorify}
      POSTGRES_USER: ${POSTGRES_USER-kitchorify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: ${PG_BACKUP_SCHEDULE-@daily}
      BACKUP_KEEP_DAYS: ${PG_BACKUP_KEEP_DAYS-14}
      BACKUP_KEEP_WEEKS: ${PG_BACKUP_KEEP_WEEKS-8}
      BACKUP_KEEP_MONTHS: ${PG_BACKUP_KEEP_MONTHS-6}
      HEALTHCHECK_PORT: 8080
    volumes:
      - ./backups:/backups
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

  print-server:
    profiles: ['print']
    build:
      context: ..
      dockerfile: deploy/services.Dockerfile
    command: ['node', 'printer-server.cjs']
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4243
      CORS_ORIGINS: ${CORS_ORIGINS}
      # Optional: if set, upstream expects x-api-key
      API_KEY: ${PRINT_API_KEY-}
      PRINT_TRANSPORT: ${PRINT_TRANSPORT-stdout}
      PRINTER_HOST: ${PRINTER_HOST-}
      PRINTER_PORT: ${PRINTER_PORT-9100}
      PRINTER_NAME: ${PRINTER_NAME-}
    expose:
      - '4243'
    networks:
      - edge
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'

volumes:
  caddy_data:
  caddy_config:
  pgdata:

networks:
  edge:
    driver: bridge
